<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI ë³´ì¹´ ìºì¹˜ (Voca Catch)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #fff5f7;
            color: #4a4a4a;
            overflow: hidden;
            touch-action: none;
        }

        .loader {
            border: 3px solid #fce7f3;
            border-radius: 50%;
            border-top: 3px solid #fb7185;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #game-canvas {
            background: linear-gradient(to bottom, #fff1f2 0%, #ffe4e6 100%);
            display: block;
            width: 100%;
            height: 100%;
        }

        .tab-btn.active {
            background-color: white;
            color: #e11d48;
            box-shadow: 0 4px 6px -1px rgba(225, 29, 72, 0.1);
        }

        .character-float {
            animation: float 2s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .custom-checkbox {
            accent-color: #fb7185;
        }

        /* ìŠ¤í¬ë¡¤ë°” ë¯¸ì„¸ ì¡°ì • */
        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #fecdd3;
            border-radius: 10px;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header (Badge Removed) -->
    <header class="bg-rose-50 border-b border-rose-100 px-4 py-3 sticky top-0 z-50">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-rose-500 tracking-tighter">Voca Catch</h1>
        </div>
    </header>

    <main class="max-w-md mx-auto px-4 mt-4">
        
        <!-- Tab Navigation -->
        <div class="flex bg-rose-100/50 p-1 rounded-xl mb-4 border border-rose-100">
            <button onclick="switchTab('scan')" id="tab-scan" class="tab-btn active flex-1 py-2 text-sm font-semibold rounded-lg transition-all text-rose-400">ìŠ¤ìº”</button>
            <button onclick="switchTab('list')" id="tab-list" class="tab-btn flex-1 py-2 text-sm font-semibold text-rose-400 rounded-lg transition-all">ë‹¨ì–´ì¥</button>
            <button onclick="switchTab('game')" id="tab-game" class="tab-btn flex-1 py-2 text-sm font-semibold text-rose-400 rounded-lg transition-all">ê²Œì„</button>
        </div>

        <!-- Section: Scan -->
        <section id="section-scan" class="space-y-4">
            <div class="bg-white p-6 rounded-2xl border border-rose-100 text-center shadow-sm">
                <div class="w-12 h-12 bg-rose-50 text-rose-400 rounded-full flex items-center justify-center mx-auto mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" />
                    </svg>
                </div>
                <h2 class="text-base font-bold mb-1 text-slate-700">ì˜ì–´ ì‚¬ì§„ ìŠ¤ìº”</h2>
                <p class="text-xs text-slate-400 mb-4">ìº¡ì²˜í•œ ì‚¬ì§„ì—ì„œ ë‹¨ì–´ë¥¼ ìë™ìœ¼ë¡œ ì¶”ì¶œí•©ë‹ˆë‹¤</p>
                <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                <button onclick="document.getElementById('imageInput').click()" class="w-full bg-rose-400 text-white py-3 rounded-xl font-bold hover:bg-rose-500 transition-colors shadow-md">
                    ì‚¬ì§„ ì„ íƒ
                </button>
            </div>

            <div id="previewContainer" class="hidden bg-white p-4 rounded-2xl border border-rose-100 shadow-sm">
                <img id="imagePreview" class="w-full h-32 object-cover rounded-xl mb-3 opacity-90">
                <button id="extractBtn" onclick="extractText()" class="w-full bg-rose-50 text-rose-500 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-rose-100 border border-rose-200">
                    <span id="btnText">AI ë‹¨ì–´ ì¶”ì¶œ ì‹œì‘</span>
                    <div id="btnLoader" class="loader hidden"></div>
                </button>
            </div>
        </section>

        <!-- Section: List -->
        <section id="section-list" class="hidden space-y-4">
            <div class="flex justify-between items-center px-1">
                <h2 class="font-bold text-slate-700">ë‚˜ì˜ ë‹¨ì–´ì¥ <span id="voca-count" class="text-rose-500 text-sm ml-1">0</span></h2>
                <button onclick="clearList()" class="text-xs text-rose-400 hover:text-rose-600">ì „ì²´ ì‚­ì œ</button>
            </div>
            <div id="voca-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-1 custom-scroll">
                <div class="text-center py-20 text-slate-300 italic">ì €ì¥ëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        </section>

        <!-- Section: Game -->
        <section id="section-game" class="hidden h-[75vh] relative overflow-hidden rounded-3xl border-4 border-rose-100 shadow-xl bg-rose-50">
            
            <!-- Game Menu -->
            <div id="game-menu" class="absolute inset-0 bg-white/95 flex flex-col items-center justify-center p-8 text-center z-30">
                <div class="text-6xl mb-4 character-float">ğŸ€</div>
                <h2 class="text-2xl font-bold mb-2 text-rose-500">ë³´ì¹´ ìºì¹˜</h2>
                <p class="text-slate-400 text-sm mb-6">ëª¨ë“  ë‹¨ì–´ë¥¼ ë§íˆë©´ ë¯¸ì…˜ ì„±ê³µ!<br>15ê°œ ì´ˆê³¼ ì‹œ í•™ìŠµí•  ë‹¨ì–´ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.</p>
                <button onclick="handleStartGame()" class="w-full max-w-xs bg-rose-400 text-white py-4 rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition-transform">ê²Œì„ ì‹œì‘</button>
            </div>

            <!-- Selection Screen -->
            <div id="game-selection" class="hidden absolute inset-0 bg-rose-50 z-40 flex flex-col p-6 overflow-hidden">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-rose-500">í•™ìŠµ ë‹¨ì–´ ì„ íƒ</h3>
                        <p class="text-[10px] text-rose-400">ì›í•˜ëŠ” ë¬¸ì¥ì„ ì²´í¬í•˜ê±°ë‚˜ ëœë¤ ì…”í”Œì„ ì´ìš©í•˜ì„¸ìš”.</p>
                    </div>
                    <button onclick="closeSelection()" class="text-rose-300 hover:text-rose-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <div id="selection-list" class="flex-1 overflow-y-auto custom-scroll space-y-2 mb-6 p-1">
                    <!-- Checkboxes -->
                </div>

                <div class="grid grid-cols-2 gap-2 mb-3">
                    <button onclick="selectRandom15()" class="bg-white text-rose-500 py-3 rounded-xl text-sm font-bold border border-rose-100 shadow-sm hover:bg-rose-50 transition-colors">
                        ğŸ² ëœë¤ 15ê°œ ì…”í”Œ
                    </button>
                    <button onclick="selectAllVoca()" id="btn-select-all" class="bg-white text-rose-500 py-3 rounded-xl text-sm font-bold border border-rose-100 shadow-sm hover:bg-rose-50 transition-colors">
                        âœ… ì „ì²´ ì„ íƒ
                    </button>
                </div>
                <button onclick="startWithSelected()" class="w-full bg-rose-400 text-white py-5 rounded-2xl font-bold text-lg shadow-lg active:scale-95 hover:bg-rose-500 transition-all">
                    ì„ íƒ ì™„ë£Œ & ê²Œì„ ì‹œì‘
                </button>
            </div>

            <!-- Game HUD -->
            <div id="game-hud" class="hidden absolute top-0 left-0 w-full p-4 flex flex-col gap-3 z-20 pointer-events-none">
                <div class="flex justify-between items-center">
                    <div class="bg-white/80 backdrop-blur-md px-4 py-1.5 rounded-full text-xs font-black border border-rose-100 text-rose-500">
                        SCORE: <span id="hud-score" class="text-rose-600">0</span>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <div id="hud-shield" class="bg-blue-400/80 hidden px-2 py-1 rounded-lg text-[10px] font-bold border border-blue-200 text-white animate-pulse">SHIELD ON</div>
                        <div class="bg-white/80 backdrop-blur-md px-4 py-1.5 rounded-full text-xs font-black border border-rose-100 text-rose-500">
                            LIFE: <span id="hud-life" class="text-rose-500">â¤ï¸â¤ï¸â¤ï¸</span>
                        </div>
                        <div class="bg-rose-400/90 backdrop-blur-md px-3 py-1 rounded-lg text-[10px] font-bold text-white">
                            REMAINING: <span id="hud-rem" class="font-black">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white text-rose-600 p-4 rounded-2xl shadow-lg text-center border-b-8 border-rose-200">
                    <div class="text-[10px] text-rose-400 font-black uppercase tracking-widest mb-1">Find Meaning of</div>
                    <div id="hud-target" class="text-2xl font-black italic">Target...</div>
                </div>
            </div>

            <canvas id="game-canvas"></canvas>

            <!-- Game Over / Win Screen -->
            <div id="game-over" class="hidden absolute inset-0 bg-rose-50 flex flex-col items-center justify-center p-8 text-center z-50">
                <h2 id="over-title" class="text-3xl font-black text-rose-500 mb-8 uppercase tracking-widest">Game Over</h2>
                <div class="bg-white p-8 rounded-3xl w-full max-w-xs mb-10 shadow-sm border border-rose-100">
                    <div class="text-xs text-rose-300 mb-2 font-bold uppercase tracking-tighter">Final Score</div>
                    <div class="text-6xl font-black text-rose-500" id="final-score">0</div>
                </div>
                <!-- Restart Button Fixed -->
                <button onclick="handleRestartClick()" class="w-full max-w-xs bg-rose-400 text-white py-5 rounded-2xl font-black text-xl shadow-lg hover:bg-rose-500 active:scale-95 transition-all">ë‹¤ì‹œ ë„ì „</button>
            </div>
        </section>
    </main>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full text-sm font-bold opacity-0 transition-opacity pointer-events-none z-[100] shadow-2xl">
        Toast
    </div>

    <script>
        const apiKey = "";
        let vocabulary = JSON.parse(localStorage.getItem('my_voca')) || [];
        let currentImageBase64 = null;

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 2000);
        }

        function switchTab(tabId) {
            const sections = ['scan', 'list', 'game'];
            sections.forEach(s => {
                document.getElementById(`section-${s}`).classList.toggle('hidden', s !== tabId);
                const btn = document.getElementById(`tab-${s}`);
                btn.classList.toggle('active', s === tabId);
                if (s === tabId) {
                    btn.classList.add('text-rose-500');
                    btn.classList.remove('text-rose-400');
                } else {
                    btn.classList.remove('text-rose-500');
                    btn.classList.add('text-rose-400');
                }
            });
            if (tabId === 'list') renderList();
            if (tabId === 'game') stopGame();
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                currentImageBase64 = e.target.result.split(',')[1];
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('previewContainer').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        async function extractText() {
            if (!currentImageBase64) return;
            const btn = document.getElementById('extractBtn');
            const loader = document.getElementById('btnLoader');
            btn.disabled = true;
            loader.classList.remove('hidden');

            const prompt = `ì´ ì´ë¯¸ì§€ì—ì„œ ì˜ì–´ ë‹¨ì–´ì™€ í•œê¸€ ëœ»ì„ ì¶”ì¶œí•´ì„œ JSON ë°°ì—´ë¡œ ì‘ë‹µí•´. í˜•ì‹: [{"english": "...", "korean": "..."}]`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: currentImageBase64 } }] }]
                    })
                });

                const data = await response.json();
                const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                const cleanedJson = resultText.replace(/```json|```/gi, '').trim();
                const newItems = JSON.parse(cleanedJson);

                if (Array.isArray(newItems)) {
                    vocabulary = [...newItems, ...vocabulary];
                    localStorage.setItem('my_voca', JSON.stringify(vocabulary));
                    showToast("ë‹¨ì–´ë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤!");
                    switchTab('list');
                }
            } catch (error) {
                console.error(error);
                showToast("ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            } finally {
                btn.disabled = false;
                loader.classList.add('hidden');
            }
        }

        function renderList() {
            const listEl = document.getElementById('voca-list');
            document.getElementById('voca-count').textContent = vocabulary.length;
            if (vocabulary.length === 0) {
                listEl.innerHTML = `<div class="text-center py-20 text-slate-300 italic">ì €ì¥ëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }
            listEl.innerHTML = vocabulary.map((item, idx) => `
                <div class="bg-white p-4 rounded-xl border border-rose-100 flex justify-between items-center shadow-sm">
                    <div>
                        <p class="font-bold text-slate-700">${item.english}</p>
                        <p class="text-slate-700 text-xs opacity-70">${item.korean}</p>
                    </div>
                    <button onclick="deleteItem(${idx})" class="text-rose-300 hover:text-rose-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function deleteItem(idx) {
            vocabulary.splice(idx, 1);
            localStorage.setItem('my_voca', JSON.stringify(vocabulary));
            renderList();
        }

        function clearList() {
            if (confirm("ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?")) {
                vocabulary = [];
                localStorage.setItem('my_voca', JSON.stringify(vocabulary));
                renderList();
            }
        }

        // --- GAME LOGIC: FLOW & RESTART ---

        function handleRestartClick() {
            document.getElementById('game-over').classList.add('hidden');
            handleStartGame();
        }

        function handleStartGame() {
            if (vocabulary.length < 4) {
                showToast("ìµœì†Œ 4ê°œì˜ ë‹¨ì–´ê°€ í•„ìš”í•©ë‹ˆë‹¤!");
                return;
            }
            // íƒ­ ë™ê¸°í™”
            switchTab('game');

            if (vocabulary.length <= 15) {
                initGame(vocabulary); 
            } else {
                showSelectionScreen();
            }
        }

        function showSelectionScreen() {
            const menu = document.getElementById('game-menu');
            const screen = document.getElementById('game-selection');
            const list = document.getElementById('selection-list');
            const gameOver = document.getElementById('game-over');
            
            gameOver.classList.add('hidden');
            menu.classList.add('hidden');
            screen.classList.remove('hidden');
            
            list.innerHTML = vocabulary.map((item, idx) => `
                <label class="flex items-center gap-3 p-4 bg-white rounded-2xl cursor-pointer hover:bg-rose-50 transition-colors border border-rose-100/50 shadow-sm">
                    <input type="checkbox" value="${idx}" class="custom-checkbox w-6 h-6">
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-sm text-slate-700 truncate">${item.english}</p>
                        <p class="text-[10px] text-slate-400 truncate">${item.korean}</p>
                    </div>
                </label>
            `).join('');
        }

        function closeSelection() {
            document.getElementById('game-selection').classList.add('hidden');
            document.getElementById('game-menu').classList.remove('hidden');
        }

        function selectRandom15() {
            const checkboxes = document.querySelectorAll('#selection-list input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            const indices = Array.from({length: checkboxes.length}, (_, i) => i);
            const shuffled = indices.sort(() => 0.5 - Math.random()).slice(0, 15);
            shuffled.forEach(idx => { checkboxes[idx].checked = true; });
            showToast("ëœë¤ìœ¼ë¡œ 15ê°œë¥¼ ì„ íƒí–ˆìŠµë‹ˆë‹¤.");
        }

        function selectAllVoca() {
            const checkboxes = document.querySelectorAll('#selection-list input[type="checkbox"]');
            const btn = document.getElementById('btn-select-all');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
            btn.textContent = !allChecked ? "âœ… ì„ íƒ í•´ì œ" : "âœ… ì „ì²´ ì„ íƒ";
        }

        function startWithSelected() {
            const selectedIndices = Array.from(document.querySelectorAll('#selection-list input[type="checkbox"]:checked'))
                                         .map(cb => parseInt(cb.value));
            if (selectedIndices.length < 4) {
                showToast("ìµœì†Œ 4ê°œ ì´ìƒì˜ ë‹¨ì–´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
            const selectedVoca = selectedIndices.map(idx => vocabulary[idx]);
            document.getElementById('game-selection').classList.add('hidden');
            initGame(selectedVoca);
        }

        // --- GAME ENGINE: VOCA CATCH ---
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        let animationId;
        let gameActive = false;
        
        let gameState = {
            playerX: 0,
            targetX: 0,
            score: 0,
            lives: 3,
            hasShield: false,
            activeVocaPool: [], 
            remainingVoca: [],  
            targetVoca: null,
            fallingItems: [],
            spawnTimer: 0,
            difficulty: 1
        };

        function resizeCanvas() {
            const container = document.getElementById('section-game');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            gameState.playerX = canvas.width / 2;
            gameState.targetX = canvas.width / 2;
        }

        function stopGame() {
            gameActive = false;
            cancelAnimationFrame(animationId);
        }

        function initGame(vocaList) {
            resizeCanvas();
            gameActive = true;
            gameState = {
                playerX: canvas.width / 2,
                targetX: canvas.width / 2,
                score: 0,
                lives: 3,
                hasShield: false,
                activeVocaPool: [...vocaList],
                remainingVoca: [...vocaList].sort(() => 0.5 - Math.random()),
                targetVoca: null,
                fallingItems: [],
                spawnTimer: 0,
                difficulty: 1
            };
            
            document.getElementById('game-menu').classList.add('hidden');
            document.getElementById('game-over').classList.add('hidden');
            document.getElementById('game-selection').classList.add('hidden');
            document.getElementById('game-hud').classList.remove('hidden');
            document.getElementById('hud-shield').classList.add('hidden');
            
            setNewTarget();
            gameLoop();
        }

        function setNewTarget() {
            if (gameState.remainingVoca.length === 0) {
                handleWin();
                return;
            }
            gameState.targetVoca = gameState.remainingVoca[0];
            document.getElementById('hud-target').textContent = gameState.targetVoca.english;
            document.getElementById('hud-score').textContent = gameState.score;
            document.getElementById('hud-life').textContent = 'â¤ï¸'.repeat(gameState.lives);
            document.getElementById('hud-rem').textContent = gameState.remainingVoca.length;
        }

        function spawnItem() {
            const rand = Math.random();
            let item = {
                x: Math.random() * (canvas.width - 100) + 50,
                y: -50,
                speed: (2 + Math.random() * 2) * gameState.difficulty,
                type: 'WORD',
                text: '',
                isCorrect: false,
                color: '#fff1f2' 
            };

            if (rand < 0.08) {
                item.type = 'SHIELD';
                item.text = 'ğŸ›¡ï¸';
            } else if (rand < 0.15) {
                item.type = 'STAR';
                item.text = 'â­';
            } else if (rand < 0.22) {
                item.type = 'BOMB';
                item.text = 'ğŸ’£';
            } else {
                const isCorrect = Math.random() > 0.7;
                if (isCorrect) {
                    item.text = gameState.targetVoca.korean;
                    item.isCorrect = true;
                } else {
                    let other;
                    do {
                        other = gameState.activeVocaPool[Math.floor(Math.random() * gameState.activeVocaPool.length)];
                    } while (other.korean === gameState.targetVoca.korean);
                    item.text = other.korean;
                }
            }

            const isOverlapping = gameState.fallingItems.some(existing => Math.abs(existing.x - item.x) < 80 && existing.y < 100);
            if (!isOverlapping) {
                gameState.fallingItems.push(item);
            }
        }

        function gameLoop() {
            if (!gameActive) return;

            gameState.spawnTimer++;
            if (gameState.spawnTimer > 70 / gameState.difficulty) {
                spawnItem();
                gameState.spawnTimer = 0;
            }

            gameState.playerX += (gameState.targetX - gameState.playerX) * 0.2;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            gameState.fallingItems.forEach((item, idx) => {
                item.y += item.speed;

                if (item.type === 'WORD') {
                    ctx.fillStyle = item.color;
                    ctx.beginPath();
                    ctx.roundRect(item.x - 60, item.y - 20, 120, 40, 15);
                    ctx.fill();
                    ctx.strokeStyle = '#fecdd3';
                    ctx.lineWidth = 1;
                    ctx.stroke();

                    ctx.fillStyle = '#e11d48';
                    ctx.font = 'bold 13px Pretendard';
                    ctx.textAlign = 'center';
                    let displayBtn = item.text.length > 10 ? item.text.substring(0, 8) + '..' : item.text;
                    ctx.fillText(displayBtn, item.x, item.y + 5);
                } else {
                    ctx.font = '30px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(item.text, item.x, item.y + 10);
                }

                const dist = Math.hypot(item.x - gameState.playerX, item.y - (canvas.height - 80));
                if (dist < 50) {
                    handleCollision(item);
                    gameState.fallingItems.splice(idx, 1);
                }

                if (item.y > canvas.height + 50) {
                    gameState.fallingItems.splice(idx, 1);
                }
            });

            const pY = canvas.height - 80;
            ctx.font = '60px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ğŸ’', gameState.playerX, pY);

            if (gameState.hasShield) {
                ctx.strokeStyle = '#60a5fa';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(gameState.playerX, pY - 20, 45, 0, Math.PI * 2);
                ctx.stroke();
            }

            animationId = requestAnimationFrame(gameLoop);
        }

        function handleCollision(item) {
            if (item.type === 'WORD') {
                if (item.isCorrect) {
                    gameState.score += 10;
                    gameState.difficulty += 0.04;
                    showToast("ì •ë‹µ! âœ¨");
                    gameState.remainingVoca.shift();
                    setNewTarget();
                } else {
                    handleDamage("ì˜¤ë‹µì…ë‹ˆë‹¤!");
                }
            } else if (item.type === 'SHIELD') {
                gameState.hasShield = true;
                document.getElementById('hud-shield').classList.remove('hidden');
                showToast("ì‹¤ë“œ íšë“!");
            } else if (item.type === 'STAR') {
                gameState.score += 50;
                document.getElementById('hud-score').textContent = gameState.score;
                showToast("ë³´ë„ˆìŠ¤! +50ì ");
            } else if (item.type === 'BOMB') {
                handleDamage("í­íƒ„!");
            }
        }

        function handleDamage(msg) {
            if (gameState.hasShield) {
                gameState.hasShield = false;
                document.getElementById('hud-shield').classList.add('hidden');
                showToast("ì‹¤ë“œ ë°©ì–´!");
            } else {
                gameState.lives--;
                document.getElementById('hud-life').textContent = 'â¤ï¸'.repeat(Math.max(0, gameState.lives));
                showToast(msg);
                if (gameState.lives <= 0) {
                    handleGameOver("Game Over");
                }
            }
        }

        function handleWin() {
            handleGameOver("Mission Clear!");
        }

        function handleGameOver(title) {
            gameActive = false;
            const overScreen = document.getElementById('game-over');
            const overTitle = document.getElementById('over-title');
            overTitle.textContent = title;
            overTitle.className = "text-3xl font-black text-rose-500 mb-8 uppercase tracking-widest";
            document.getElementById('final-score').textContent = gameState.score;
            overScreen.classList.remove('hidden');
        }

        canvas.addEventListener('mousemove', e => {
            const rect = canvas.getBoundingClientRect();
            gameState.targetX = e.clientX - rect.left;
        });

        canvas.addEventListener('touchmove', e => {
            const rect = canvas.getBoundingClientRect();
            gameState.targetX = e.touches[0].clientX - rect.left;
            e.preventDefault();
        }, { passive: false });

        window.addEventListener('keydown', e => {
            if (e.key === 'ArrowLeft') gameState.targetX = Math.max(0, gameState.targetX - 50);
            if (e.key === 'ArrowRight') gameState.targetX = Math.min(canvas.width, gameState.targetX + 50);
        });

        window.onload = () => switchTab('scan');
    </script>
</body>
</html>
