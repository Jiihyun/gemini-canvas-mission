<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SnapClean</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* Custom Scrollbar for Thumbnails */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* Animations */
    @keyframes bounce-in {
      0% { transform: scale(0.9); opacity: 0; }
      50% { transform: scale(1.05); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    .animate-bounce-in { animation: bounce-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

  <div class="w-full h-screen sm:h-[850px] sm:max-w-[400px] sm:rounded-[40px] sm:overflow-hidden sm:shadow-[0_20px_50px_rgba(0,0,0,0.15)] sm:border-8 border-slate-800 bg-white relative mx-auto font-sans flex flex-col">
    
    <!-- Toast Notification -->
    <div id="toast" class="hidden absolute top-12 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-5 py-3 rounded-2xl shadow-2xl z-[100] text-sm font-bold flex items-center gap-2 transition-all duration-300 transform scale-90 opacity-0">
      <i data-lucide="check-circle-2" class="w-5 h-5 text-emerald-400"></i>
      <span id="toast-message"></span>
    </div>

    <!-- File Input (Hidden) -->
    <input type="file" id="file-upload" multiple accept="image/*" class="hidden">

    <!-- Views -->
    <div id="home-view" class="flex-1 flex flex-col h-full bg-slate-50 relative pb-20 hidden"></div>
    <div id="sorting-view" class="flex-1 fixed inset-0 sm:absolute bg-black text-white flex flex-col z-50 hidden"></div>
    <div id="trash-view" class="flex-1 flex flex-col h-full bg-slate-50 relative pb-20 hidden"></div>

    <!-- Bottom Navigation -->
    <div id="bottom-nav" class="absolute bottom-0 left-0 right-0 bg-white border-t border-slate-100 px-6 py-4 flex justify-around items-center z-20 pb-safe pb-6">
      <button onclick="setView('home')" id="nav-home" class="flex flex-col items-center gap-1 transition-colors text-indigo-600">
        <i data-lucide="sparkles" class="w-6 h-6 fill-indigo-100" id="nav-icon-home"></i>
        <span class="text-[10px] font-bold">정리하기</span>
      </button>
      <button onclick="setView('trash')" id="nav-trash" class="flex flex-col items-center gap-1 transition-colors relative text-slate-400 hover:text-slate-600">
        <div class="relative">
          <i data-lucide="trash-2" class="w-6 h-6" id="nav-icon-trash"></i>
          <span id="trash-badge" class="hidden absolute -top-1 -right-1.5 bg-rose-500 text-white text-[10px] font-bold px-1.5 rounded-full border-2 border-white">0</span>
        </div>
        <span class="text-[10px] font-bold">삭제 후보함</span>
      </button>
    </div>
  </div>

  <script>
    // --- Mock Data (기본 샘플) ---
    const MOCK_GROUPS = [
      {
        id: 'g1',
        title: '인물 포즈 연속촬영',
        photos: [
          { id: 'p1_1', url: 'https://images.unsplash.com/photo-1534528741775-53994a69daeb?auto=format&fit=crop&w=400&q=80' },
          { id: 'p1_2', url: 'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&w=400&q=80' },
          { id: 'p1_3', url: 'https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?auto=format&fit=crop&w=400&q=80' },
          { id: 'p1_4', url: 'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=400&q=80' },
        ]
      }
    ];

    // --- State ---
    let view = 'home';
    let groups = JSON.parse(JSON.stringify(MOCK_GROUPS));
    let trash = [];
    
    let activeGroupIndex = null;
    let currentPhotoIndex = 0;
    let likedPhotos = new Set();
    let toastTimeout = null;

    // --- DOM Elements ---
    const homeViewEl = document.getElementById('home-view');
    const sortingViewEl = document.getElementById('sorting-view');
    const trashViewEl = document.getElementById('trash-view');
    const bottomNavEl = document.getElementById('bottom-nav');
    const toastEl = document.getElementById('toast');
    const toastMessageEl = document.getElementById('toast-message');
    const fileUploadEl = document.getElementById('file-upload');
    const trashBadge = document.getElementById('trash-badge');

    // --- File Upload & Fake AI Grouping Logic ---
    window.triggerFileUpload = () => {
      fileUploadEl.click();
    };

    fileUploadEl.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;

      showToast("AI가 사진 촬영 시간을 분석 중입니다...");

      // 1. 파일 수정 시간(찍힌 시간) 기준으로 정렬
      files.sort((a, b) => a.lastModified - b.lastModified);

      let newGroups = [];
      let currentGroup = [];

      // 2. 60초(60000ms) 이내에 찍힌 사진들을 같은 묶음으로 분류 (시간 기반 알고리즘)
      for (let i = 0; i < files.length; i++) {
        if (currentGroup.length === 0) {
          currentGroup.push(files[i]);
        } else {
          const prevFile = currentGroup[currentGroup.length - 1];
          if (files[i].lastModified - prevFile.lastModified < 60000) {
            currentGroup.push(files[i]);
          } else {
            newGroups.push(currentGroup);
            currentGroup = [files[i]];
          }
        }
      }
      if (currentGroup.length > 0) newGroups.push(currentGroup);

      // 3. 2장 이상 묶인 사진만 '연사 그룹'으로 인정하여 추가, 1장짜리는 무시 (또는 강제로 테스트용 그룹화)
      const validGroups = newGroups.filter(g => g.length > 1);
      
      if (validGroups.length === 0) {
        // 만약 찍힌 시간이 다 제각각이라 묶인게 없다면, 테스트를 위해 그냥 4장씩 강제로 묶어버림
        let chunkedGroups = [];
        for (let i = 0; i < files.length; i += 4) {
          chunkedGroups.push(files.slice(i, i + 4));
        }
        processFileGroups(chunkedGroups.filter(g => g.length > 1));
        setTimeout(() => showToast("연속 촬영된 사진이 없어 임의로 묶었습니다!"), 1000);
      } else {
        processFileGroups(validGroups);
        setTimeout(() => showToast(`시간 분석 완료! ${validGroups.length}개의 묶음을 찾았습니다.`), 1000);
      }
      
      // 입력창 초기화
      fileUploadEl.value = '';
    });

    function processFileGroups(groupedFiles) {
      const newAppGroups = groupedFiles.map((g, idx) => {
        return {
          id: `local_g_${Date.now()}_${idx}`,
          title: `PC에서 찾은 연사 묶음 ${idx + 1}`,
          photos: g.map((f, pIdx) => ({
            id: `local_p_${Date.now()}_${idx}_${pIdx}`,
            url: URL.createObjectURL(f)
          }))
        };
      });
      
      groups = [...newAppGroups, ...groups]; // 새로 추가한 걸 맨 위로
      render();
    }

    // --- Core Functions ---
    window.setView = (newView) => { view = newView; render(); };

    window.showToast = (msg) => {
      toastMessageEl.innerText = msg;
      toastEl.classList.remove('hidden');
      void toastEl.offsetWidth;
      toastEl.classList.remove('scale-90', 'opacity-0');
      toastEl.classList.add('scale-100', 'opacity-100', 'animate-bounce-in');
      clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => {
        toastEl.classList.remove('scale-100', 'opacity-100', 'animate-bounce-in');
        toastEl.classList.add('scale-90', 'opacity-0');
        setTimeout(() => toastEl.classList.add('hidden'), 300);
      }, 3000);
    };

    window.startSorting = (index) => {
      activeGroupIndex = index;
      currentPhotoIndex = 0;
      likedPhotos.clear();
      setView('sorting');
    };

    window.toggleLike = (photoId) => {
      if (likedPhotos.has(photoId)) likedPhotos.delete(photoId);
      else likedPhotos.add(photoId);
      renderSortingView();
    };

    window.setCurrentPhotoIndex = (index) => {
      const group = groups[activeGroupIndex];
      if (!group) return;
      currentPhotoIndex = Math.max(0, Math.min(group.photos.length - 1, index));
      renderSortingView();
    };

    window.finishSorting = () => {
      const group = groups[activeGroupIndex];
      const kept = [];
      const trashed = [];

      group.photos.forEach(photo => {
        if (likedPhotos.has(photo.id)) kept.push(photo);
        else trashed.push({ ...photo, deletedAt: new Date(), groupTitle: group.title });
      });

      trash = [...trash, ...trashed];
      groups.splice(activeGroupIndex, 1);
      
      showToast(`${kept.length}장 유지, ${trashed.length}장이 삭제 후보함으로 이동했습니다.`);
      setView('home');
    };

    window.recoverPhoto = (photoId) => {
      trash = trash.filter(p => p.id !== photoId);
      showToast('사진이 복구되었습니다.');
      render();
    };

    window.emptyTrash = () => {
      trash = [];
      showToast('휴지통이 비워졌습니다.');
      render();
    };

    // --- Keyboard Navigation ---
    document.addEventListener('keydown', (e) => {
      if (view !== 'sorting' || activeGroupIndex === null) return;
      const group = groups[activeGroupIndex];
      if (!group) return;
      const photo = group.photos[currentPhotoIndex];

      if (e.key === 'ArrowLeft') {
        setCurrentPhotoIndex(currentPhotoIndex - 1);
      } else if (e.key === 'ArrowRight') {
        setCurrentPhotoIndex(currentPhotoIndex + 1);
      } else if (e.key === 'ArrowDown') {
        likedPhotos.add(photo.id);
        setCurrentPhotoIndex(currentPhotoIndex + 1);
      }
    });

    // --- Renderers ---
    function render() {
      homeViewEl.classList.toggle('hidden', view !== 'home');
      sortingViewEl.classList.toggle('hidden', view !== 'sorting');
      trashViewEl.classList.toggle('hidden', view !== 'trash');
      bottomNavEl.classList.toggle('hidden', view === 'sorting');

      if (view === 'home') renderHomeView();
      if (view === 'sorting') renderSortingView();
      if (view === 'trash') renderTrashView();

      const navHomeEl = document.getElementById('nav-home');
      const navTrashEl = document.getElementById('nav-trash');
      const navIconHome = document.getElementById('nav-icon-home');
      const navIconTrash = document.getElementById('nav-icon-trash');

      if (view === 'home') {
        navHomeEl.className = "flex flex-col items-center gap-1 transition-colors text-indigo-600";
        navIconHome.setAttribute('class', "w-6 h-6 fill-indigo-100");
        navTrashEl.className = "flex flex-col items-center gap-1 transition-colors relative text-slate-400 hover:text-slate-600";
        navIconTrash.setAttribute('class', "w-6 h-6");
      } else if (view === 'trash') {
        navHomeEl.className = "flex flex-col items-center gap-1 transition-colors text-slate-400 hover:text-slate-600";
        navIconHome.setAttribute('class', "w-6 h-6");
        navTrashEl.className = "flex flex-col items-center gap-1 transition-colors relative text-indigo-600";
        navIconTrash.setAttribute('class', "w-6 h-6 fill-indigo-100");
      }

      if (trash.length > 0) {
        trashBadge.innerText = trash.length;
        trashBadge.classList.remove('hidden');
      } else {
        trashBadge.classList.add('hidden');
      }

      setTimeout(() => lucide.createIcons(), 0);
    }

    function renderHomeView() {
      const totalPhotos = groups.reduce((acc, g) => acc + g.photos.length, 0);
      const savedSpace = Math.floor(totalPhotos * 3.5);

      let headerHTML = `
        <div class="bg-white px-6 pt-12 pb-8 rounded-b-3xl shadow-sm z-10">
          <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">SnapClean</h1>
          <p class="text-slate-500 mt-2 font-medium text-sm">연속 촬영된 비슷한 사진들을 빠르게 정리하세요.</p>
          
          <button onclick="triggerFileUpload()" class="mt-4 w-full bg-slate-800 text-white font-bold py-3.5 rounded-2xl flex items-center justify-center gap-2 hover:bg-slate-700 transition active:scale-[0.98] shadow-lg shadow-slate-200">
            <i data-lucide="image-plus" class="w-5 h-5"></i> 내 PC 사진 여러장 불러오기
          </button>

          ${groups.length > 0 ? `
            <div class="mt-4 bg-indigo-50 border border-indigo-100 p-4 rounded-2xl flex items-start gap-3">
              <i data-lucide="sparkles" class="text-indigo-500 w-6 h-6 flex-shrink-0 mt-0.5"></i>
              <div>
                <p class="text-indigo-900 font-bold leading-tight">오늘 ${groups.length}개의 묶음에서<br/>총 ${totalPhotos}장을 정리할 수 있습니다.</p>
                <p class="text-indigo-600 text-xs mt-1">약 ${savedSpace}MB의 저장공간 확보 가능</p>
              </div>
            </div>
          ` : `
             <div class="mt-4 bg-emerald-50 border border-emerald-100 p-4 rounded-2xl flex items-center gap-3">
              <i data-lucide="check-circle-2" class="text-emerald-500 w-6 h-6 flex-shrink-0"></i>
              <p class="text-emerald-900 font-bold text-sm">정리할 묶음이 없습니다.</p>
            </div>
          `}
        </div>
      `;

      let groupsHTML = groups.map((group, idx) => {
        let photosStackHTML = group.photos.slice(0, 5).map((photo, i, arr) => {
          const isCenter = (arr.length - 1) / 2;
          const offset = i - isCenter;
          const rotate = offset * 6;
          const translateX = offset * 32;
          return `
            <div class="absolute w-24 h-24 sm:w-28 sm:h-28 rounded-xl shadow-[0_4px_15px_rgba(0,0,0,0.12)] border-4 border-white overflow-hidden bg-slate-200 transition-transform duration-300 group-hover/card:scale-105"
                 style="transform: translateX(${translateX}px) rotate(${rotate}deg); z-index: ${i};">
              <img src="${photo.url}" alt="burst frame" class="w-full h-full object-cover" />
            </div>
          `;
        }).join('');

        return `
          <button onclick="startSorting(${idx})" class="w-full bg-white p-5 rounded-3xl shadow-sm border border-slate-100 flex flex-col gap-4 hover:shadow-md transition-all active:scale-[0.98] group/card relative overflow-hidden">
            ${group.id.includes('local') ? '<div class="absolute top-0 right-0 bg-indigo-500 text-white text-[10px] font-bold px-3 py-1 rounded-bl-xl">MY PC</div>' : ''}
            <div class="flex justify-center w-full px-1">
              <div class="bg-slate-100 text-slate-700 px-4 py-1.5 rounded-full text-sm font-bold flex items-center gap-1 shadow-sm">
                총 ${group.photos.length}장
              </div>
            </div>
            <div class="w-full h-40 sm:h-44 bg-slate-50 rounded-2xl relative flex items-center justify-center my-2 pointer-events-none border border-slate-100 shadow-inner overflow-hidden">
              ${photosStackHTML}
            </div>
            <div class="w-full bg-indigo-50/50 group-hover/card:bg-indigo-50 text-indigo-600 font-bold py-3.5 rounded-2xl flex items-center justify-center gap-2 transition-colors">
              묶음 정리 시작하기 <i data-lucide="chevron-right" class="w-4 h-4"></i>
            </div>
          </button>
        `;
      }).join('');

      let contentHTML = `
        <div class="flex-1 overflow-y-auto px-6 pt-6 pb-24">
          ${groups.length > 0 ? `<h2 class="text-lg font-bold text-slate-700 mb-4">정리 대기 중</h2>` : ''}
          <div class="space-y-6">
            ${groupsHTML}
          </div>
        </div>
      `;

      homeViewEl.innerHTML = headerHTML + contentHTML;
    }

    function renderSortingView() {
      const group = groups[activeGroupIndex];
      if (!group) return;
      const photo = group.photos[currentPhotoIndex];
      const isLiked = likedPhotos.has(photo.id);

      let thumbnailsHTML = group.photos.map((p, idx) => {
        const isCurrent = idx === currentPhotoIndex;
        const pLiked = likedPhotos.has(p.id);
        return `
          <button onclick="setCurrentPhotoIndex(${idx})" class="relative rounded-md overflow-hidden flex-shrink-0 transition-all duration-200 ease-out ${isCurrent ? 'w-14 h-14 sm:w-16 sm:h-16 ring-2 ring-white shadow-lg opacity-100' : 'w-10 h-10 sm:w-12 sm:h-12 opacity-50 hover:opacity-80'}">
            <img src="${p.url}" class="w-full h-full object-cover" />
            ${pLiked ? `
              <div class="absolute top-1 right-1 bg-rose-500 rounded-full p-0.5 shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
              </div>
            ` : ''}
          </button>
        `;
      }).join('');

      sortingViewEl.innerHTML = `
        <div class="pt-12 pb-4 px-4 flex items-center justify-between z-10 bg-gradient-to-b from-black/60 to-transparent">
          <button onclick="setView('home')" class="p-2 -ml-2 text-white/80 hover:text-white active:scale-90 transition">
            <i data-lucide="arrow-left" class="w-6 h-6"></i>
          </button>
          <div class="text-center">
            <p class="text-base font-bold text-white/90 tracking-widest">${currentPhotoIndex + 1} / ${group.photos.length}</p>
          </div>
          <button onclick="finishSorting()" class="bg-white/20 hover:bg-white/30 px-4 py-1.5 rounded-full text-sm font-bold backdrop-blur-md transition active:scale-95">
            정리 완료
          </button>
        </div>

        <div class="flex-1 relative flex items-center justify-center overflow-hidden touch-none">
          <img src="${photo.url}" alt="sorting" class="w-full h-full object-contain transition-opacity duration-300 ease-in-out pointer-events-none" />

          ${currentPhotoIndex > 0 ? `
            <button onclick="setCurrentPhotoIndex(${currentPhotoIndex - 1})" class="absolute left-0 top-0 bottom-32 w-1/3 z-10 cursor-pointer outline-none focus:outline-none flex items-center pl-4 opacity-0 hover:opacity-100 transition-opacity">
              <i data-lucide="chevron-left" class="w-10 h-10 text-white drop-shadow-lg"></i>
            </button>
          ` : ''}
          ${currentPhotoIndex < group.photos.length - 1 ? `
            <button onclick="setCurrentPhotoIndex(${currentPhotoIndex + 1})" class="absolute right-0 top-0 bottom-32 w-1/3 z-10 cursor-pointer outline-none focus:outline-none flex items-center justify-end pr-4 opacity-0 hover:opacity-100 transition-opacity">
              <i data-lucide="chevron-right" class="w-10 h-10 text-white drop-shadow-lg"></i>
            </button>
          ` : ''}
        </div>

        <div class="pb-8 pt-6 bg-gradient-to-t from-black/90 via-black/60 to-transparent flex flex-col items-center z-20">
          <p class="text-xs text-white/70 mb-4 flex items-center gap-1">
            <i data-lucide="info" class="w-4 h-4"></i> 키보드 방향키: ↓ 좋아요, ↔ 이전/다음
          </p>
          
          <button onclick="toggleLike('${photo.id}')" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full flex items-center justify-center shadow-2xl transition-all duration-300 transform active:scale-90 ${isLiked ? 'bg-rose-500 scale-110 shadow-rose-500/50' : 'bg-white/10 border-2 border-white/30 hover:bg-white/20'}">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="w-8 h-8 sm:w-10 sm:h-10 transition-colors ${isLiked ? 'text-white fill-white' : 'text-white'}" fill="${isLiked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
          </button>
          
          <div class="w-full mt-6 overflow-x-auto hide-scrollbar px-4">
            <div class="flex gap-2 w-max mx-auto items-center pb-2">
              ${thumbnailsHTML}
            </div>
          </div>
        </div>
      `;
      setTimeout(() => lucide.createIcons(), 0);
    }

    function renderTrashView() {
      let contentHTML = '';
      if (trash.length === 0) {
        contentHTML = `
          <div class="h-full flex flex-col items-center justify-center text-slate-400 gap-4 mt-20">
            <i data-lucide="trash-2" class="w-16 h-16 text-slate-200"></i>
            <p class="font-medium text-lg text-slate-500">삭제 후보 사진이 없습니다.</p>
          </div>
        `;
      } else {
        const gridItems = trash.map(photo => `
          <div class="relative group rounded-xl overflow-hidden aspect-[3/4] shadow-sm border border-slate-200">
            <img src="${photo.url}" alt="trashed" class="w-full h-full object-cover" />
            <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col justify-end p-3">
              <button onclick="recoverPhoto('${photo.id}')" class="bg-white/20 hover:bg-white text-white hover:text-slate-900 w-full py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 backdrop-blur-sm transition active:scale-95">
                <i data-lucide="refresh-ccw" class="w-4 h-4"></i> 복구하기
              </button>
            </div>
            <div class="absolute top-2 right-2 bg-black/60 text-white p-1.5 rounded-full backdrop-blur-sm">
              <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
            </div>
          </div>
        `).join('');
        contentHTML = `<div class="grid grid-cols-2 gap-3">${gridItems}</div>`;
      }

      trashViewEl.innerHTML = `
        <div class="bg-white px-6 pt-12 pb-6 border-b border-slate-100 sticky top-0 z-10 flex justify-between items-end">
          <div>
            <h1 class="text-2xl font-extrabold text-slate-800 tracking-tight">삭제 후보함</h1>
            <p class="text-slate-500 text-sm mt-1 font-medium">30일 후 완전히 삭제됩니다.</p>
          </div>
          ${trash.length > 0 ? `
            <button onclick="emptyTrash()" class="text-rose-500 text-sm font-bold bg-rose-50 px-3 py-1.5 rounded-lg hover:bg-rose-100 transition active:scale-95">
              모두 비우기
            </button>
          ` : ''}
        </div>
        <div class="flex-1 overflow-y-auto px-4 py-6">
          ${contentHTML}
        </div>
      `;
    }

    render();
  </script>
</body>
</html>
